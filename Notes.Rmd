---
title: "Notes"
output: html_document
---

Network ecology has largely improved our understanding of multitrophis ecological communities, specially on bipartite networks depicting two interactimg guilds. While most networks are defined at the community level (Bascompte, etc...), ecological processes take place at the individual level. In fact, individual based networks has revealed important evolutionary (Roca) and ecological (Jordano) processes. However, a limitation of this type of networks is that only individuals of a single species, usually a plant species, along with the interactions with other species, are considered. Including simultaneously the relationships between different individuals belonging to different species is challenging both conceptually and mathematically. Here we show how we can use multilayer networks to understand the general patterns of connections between conspecific and heterospecific individuals. This allows characterizing both the nodes roles (Centrality papers) in the network and the overall network structure (Pilosof). Further, the most interesting process may be at the mesoscale (Simmons). We indtroduce here the concept of hetero and homospecific motifs, rooted on triplets and diamond ...(Melian, Sauve...). By relating individual positions in the network to its fitness for complete communities, we can .... blah...

Note from Oscar: make sure to stres we do not try to compare its performance with visitation rate (Magrach 2020), but to understand mechanisms of complex interactions that spread through the network.

Specifically we aim to:

1) Describe the individual multilayer network modularity and assess how species (layers) cluster within and among modules. For examples, networks where individuals from  the same species cluster toguether will be .... 

2) Relate individuals within layer centrality (proxy of pollen flow) and among layer centrality (proxy of heterospecific pollen competition) to its fitness.

3) Relate the mesostructure of heterospecific and homospecific motifs to plant fitness. 

Alfonso, can you define exactly how a network and a motif is defined? This is important to ensure abundance is not messing up. Our unit of fitness is the individual.

----
A) MOTIF

"Following Milo, network motifs are patterns of interconnections occurring in such systems. As an example, let us consider the following undirected network: “A--B--C--D”. It is possible to see that the (undirected) pattern of connections “x1--x2--x3” (denoted here as triplet) appears twice: “A--B--C” and “B--C--D".

In this study, our motif analysis focuses on (monolayer) plant-pollinator bipartite, undirected networks. Specifically, we identify the triplets that arise in those arrangements and classify them into homospecific and heterospecific motifs. The former refers to triplets with two plant nodes that belong to the same species, and the latter to the remaining cases. Notice that, it possible to restrict the heterospecific class to motifs with at least two plants that are different one another.

At the moment, I’ve been working with plot networks, that is, plant-pollinator interactions within a given plot. For example, let us suppose that hoverflies visit 3 times the 4 CHFU plants in (plot=3, subplot=A6), then the corresponding network for plot 3 will include the weighted link “A6 CHFU” -- hoverflies with weight = 3. Besides, if hoverflies also visit twice the CHFU plant in (plot=3, subplot=D3), the homospecific triplet “A6 CHFU” -3- hoverflies -2- “D3 CHFU” appears in plot 3. For the sake of simplicity, I do not consider the weight of the links to count the triplets. For instance, given the triplets “A6 CHFU” -3- hoverflies -2- “D3 CHFU” and “A6 CHFU” -3- hoverflies -1- “F2 CHFU”, “A6 CHFU” has only two homospecific triplets, despite there are 4 CHFU plants in A6, 1 in D3, and 5 in F2.”

Hetero PPA
Homo PPA
PAA -> Not relevant to pollen flow. BUT may be important for positive negative interactions. e.g. beetles, bees.
cuadruples... -> For the future.
Crithyl

----
B) LAYER
"Consider a plot with 36 different positions, P plant species, and G functional groups of pollinators. If a multiplex arrangement is implemented, each layer should contain the state-nodes of the “36xP” different plants and G state-nodes for pollinators. For example, in the case of 6 plant species and 8 functional groups, each layer will contain 216+8 nodes. If each layer (when considered in isolation) corresponds with intraspecific flow of pollen, there will be only P layers in the multiplex (e.g., layer PUPA, layer CHFU, etc.), and, the interactions in the P-th layer (i.e., the intra-links of layer P) will be restricted to those connections between the plants that belong to P and its pollinators. For instance, according to the prior examples, the multiplex network for plot 3 contains a layer CHFU, where hoverflies are connected with “A6 CHFU” (weight=3), “D3 CHFU” (weight=2), and “F2 CHFU” (weight=1)."

---
C) INTER-LAYER
"In the multiplex arrangements the state-nodes of a given agent are connected to their respective copies in other layer. Those connections are the inter-link. For example, hoverflies in layer CHFU are linked hoverflies in layer PUPA, and so on. Assuming that all the interlinks have the same weight, in the limit of very strong couplings (i.e., huge inter-link weights), we should recover the bipartite network described above. From a diffusive perspective, when the coupling strenght tends to infinity, the multiplex reduces to the superposition of its layers."
weight can be a function of 1) phenological overlap among plants and 2) temporal sequence

---
D) GLMMs

To explore the influence of floral visitors on plant species fitness, we fit GLMM for LEMA, CHFU, and PUPA. 


```{r}
# Load data and prepare data---------------------------------------------------------------

library(tidyverse)

fitness_final_aux <- read.csv(file = "data_models_phenol_overlap.csv",
                         header = TRUE)

# Add G_F

G_F_list <- read_csv("Raw_Data/Metadata_Pollinators_Abundances_Seeds_2019_ID.csv") %>%
  dplyr::select(G_F,ID_Simple) %>% rename(ID=ID_Simple) %>% unique()

G_F_list <- bind_rows(G_F_list,tibble(G_F="None",ID="None"))

# Fix "Odontomyia_sp."

G_F_list$G_F[G_F_list$ID=="Odontomyia_sp."] <- "Small_flies"
G_F_list <- unique(G_F_list)

# Sanity check
G_F_list %>% group_by(ID) %>% count() %>% filter(n>1)

fitness_data <- fitness_final_aux %>% dplyr::left_join(G_F_list,by = "ID")

# Turn ID, GF and Plot into factors
fitness_data$Plot <- as.factor(fitness_data$Plot)
fitness_data$ID <- as.factor(fitness_data$ID)
fitness_data$G_F <- as.factor(fitness_data$G_F)

# Data for plant species

# remove fitness = 0
fitness_data_fil <- filter(fitness_data,Seeds_GF > 0)

fitness_LEMA <- filter(fitness_data_fil,Plant_Simple == "LEMA")
fitness_PUPA <- filter(fitness_data_fil,Plant_Simple == "PUPA")
fitness_CHFU <- filter(fitness_data_fil,Plant_Simple == "CHFU")

```

In our models the response variable is the # of seeds, while the predictor ones are several structural metrics of plant-pollinator networks, namely: the normalized in-degree of plant nodes (denoted here as DegreeIn), and the total amount of heterospecific (HE) and homospecific (HO) motifs, respectively. To calculate the latter, we add the amount of HE and HO motifs observed over the weeks for a given pollinator and plant. The weekly amount of motifs is estimated from weekly plant-pollinator networks. To control the unobserved heterogeneity of plant visitors, we add a group (or random) effect whose category values are the functional groups of such animals, namely: Bees, beetles, butterflies, flies, flower beetles,house flies, hoverflies, humbleflies, small_beetles, small_flies and none (which refers to the absence of animal visits).

Since the response variable (seeds) refers to counts and the probability density of each plant species does not meet Poisson requirements (i.e., its mean is not aprox. equal to its variance), we fit GLMMs by using a negative binomial distribution. After removing the observations with #seeds = NA and floral visits. The models are as follows:

```{r}
# Load data and prepare data---------------------------------------------------------------

library(tidyverse)

library(MASS)
library(glmmTMB)
library(DHARMa)

LEMA <- glmmTMB(Seeds_GF ~ scale(homo_motif) +
                        scale(hete_motif) + 
                        scale(DegreeIn) + 
                        (1|G_F),
                      family = nbinom2(),
                      data = fitness_LEMA)

LEMA_Plot <- glmmTMB(Seeds_GF ~ scale(homo_motif) +
                        scale(hete_motif) + 
                        scale(DegreeIn) + 
                        (1|Plot)+
                        (1|G_F),
                      family = nbinom2(),
                      data = fitness_LEMA)

PUPA <- glmmTMB(Seeds_GF ~ scale(homo_motif) + 
                        # scale(hete_motif) + 
                        scale(DegreeIn) + 
                        (1|G_F),
                      family = nbinom1(),
                      data = fitness_PUPA)

CHFU <- glmmTMB(Seeds_GF ~ scale(homo_motif) + 
                        scale(hete_motif) + 
                        scale(DegreeIn) + 
                        (1|G_F),
                      family = nbinom2(),
                      data = fitness_CHFU)

```
where nbinom1 is the negative binomial distribution with linear parameterizationa (also called quasi-poisson) and nbinom2 represents the negative binomial distribution with quadratic parameterization (the default negative binomial in most packages). nbinom1 has variance = µ * phi where µ is the mean and phi is the over-dispersion parameter, while nbinom2 has variance = µ(1+µ/k).


After simulating the residuals, we obtain the following diagnostics:

```{r}
# get residuals

res_LEMA <- simulateResiduals(fittedModel = LEMA, n = 1500)
res_LEMA_Plot <- simulateResiduals(fittedModel = LEMA_Plot, n = 1500)
res_PUPA <- simulateResiduals(fittedModel = PUPA, n = 1500)
res_CHFU <- simulateResiduals(fittedModel = CHFU, n = 1500)

plot(res_LEMA) #KS + heter.
plot(res_PUPA) #heter.
plot(res_CHFU) #KS
``` 

                      
Quantile results for LEMA can be improved by adding the following cross-effect: (1|Plot). However, the latter worsen the KS results. 

```{r}
plot(res_LEMA_Plot) #KS + heter.
``` 

Finally it is worth mentioning that the addition of zero-inflation factors to the previous models worsen their residuals results.

----

Open Questions:
- Which plant species to select: The 6 with pollinators.
- How to group pollinators: Guild? / Species? -> Ok, but Sup Mat to check Func groups are representative (See Rachael Winfree papers). Maria can do that.
- How to weight the networks: By frequency? By visitation rate? Binary?
- Should we restrict interactions ALSO by distance and guild combination. That is, two individuals will share pollinators if 1) the same species visit both subplots AND 2) the subplots are closer than the typical pollinator foraging distance. Is this too complex and is better to assume full connectivity within plot?
Alfonso: If we define "closeness" and foraging distances, we could implement the above restrictions. For example, our algorithms can be adapted to take into account Chebyshev (o chess) distance (see Moore's neighboorhood). -> For discusion for now? Maybe across 1,2,3 - 4,5,6 - 7,8,9
- Alfonso: If we dare, we could explore also phenology by using abundace file info. 
YES, If two species do not overlap phenologically, can not create a motif. -> Maria has this data.

Analysis: 
- Basic description of the 9 ntw: modularity, centrality, motif distribution. Do we need null models? e.g. hay más homo o hetero motifs que los predichos por azar.

- Correlation centrality measures to fitness per individual.

- Correlation of participation in hetero and homo motifs with fitness per individual.

















